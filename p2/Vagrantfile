Vagrant.configure("2") do |config|
  config.vm.box = "generic/debian12"

  config.vm.synced_folder "./k8s", "/home/vagrant/k8s"

  config.vm.define "hmaciel-S" do |node|
    node.vm.hostname = "hmaciel-S"

    node.vm.network "private_network",
      ip: "192.168.56.110",
      mac: "52:54:00:aa:bb:10",
      libvirt__network_name: "vagrant-nat-net"

    node.vm.provider :libvirt do |libvirt|
      libvirt.memory = 2048
      libvirt.cpus = 2
    end

    node.vm.provision "shell", inline: <<-SHELL
      apt-get update -y
      apt-get install -y curl

      echo "=== Installing K3s ==="
      curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode=644" sh -

      echo "=== Applying Kubernetes manifests ==="
      kubectl apply -f /home/vagrant/k8s/app1.yaml
      kubectl apply -f /home/vagrant/k8s/app2.yaml
      kubectl apply -f /home/vagrant/k8s/app3.yaml

      echo "=== K3s installation and app deployment complete ==="
      kubectl get pods --all-namespaces
    SHELL
  end
end
