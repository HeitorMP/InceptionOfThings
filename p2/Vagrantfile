Vagrant.configure("2") do |config|
  config.vm.box = "generic/debian12"

  config.vm.synced_folder "./k8s", "/home/vagrant/k8s", type: "rsync"

  config.vm.define "ialves-S" do |node|
    node.vm.hostname = "ialves-S"

    # Bridge network for easy access
    node.vm.network "public_network", bridge: "en0"

    node.vm.provider :virtualbox do |vb|
      vb.memory = 2048
      vb.cpus = 2
      vb.name = "ialves-S"
    end

    node.vm.provision "shell", inline: <<-SHELL
      # Configure DNS for Ubuntu Server
      cat > /etc/netplan/99-custom-dns.yaml << 'EOF'
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: true
      dhcp4-overrides:
        use-dns: false
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
EOF
      netplan apply

      apt-get update -y
      apt-get install -y curl

      # Copy k8s manifests to proper location
      mkdir -p /home/vagrant/k8s
      cp /tmp/k8s/*.yaml /home/vagrant/k8s/
      chown -R vagrant:vagrant /home/vagrant/k8s

      echo "=== Installing K3s ==="
      curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="\
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --bind-address=192.168.56.110 \
            --advertise-address=192.168.56.110 \
            --node-ip=192.168.56.110 \
            --node-external-ip=192.168.56.110" \
          sh -

      echo "=== Waiting for K3s to be ready ==="
      sleep 10
      until kubectl get nodes &>/dev/null; do
        echo "Waiting for K3s..."
        sleep 5
      done

      echo "=== Applying Kubernetes manifests ==="
      kubectl apply -f /home/vagrant/k8s/app1.yaml
      kubectl apply -f /home/vagrant/k8s/app2.yaml
      kubectl apply -f /home/vagrant/k8s/app3.yaml

      echo "=== K3s installation and app deployment complete ==="
      kubectl get pods --all-namespaces
    SHELL

    node.vm.provision "file", source: "./k8s", destination: "/tmp/k8s"
  end
end
