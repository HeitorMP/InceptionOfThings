Vagrant.configure("2") do |config|
  config.vm.box = "bento/debian-12"

  # =====================================================
  # COMMON BASE SETUP (applies to all VMs)
  # =====================================================
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update -y
    apt-get install -y curl rsync openssh-client openssh-server sshpass
    systemctl enable ssh
    systemctl start ssh

    # Set root password for all VMs (rootpass)
    echo "root:rootpass" | chpasswd

    # Allow root login with password via SSH
    sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
    sed -i 's/^PermitRootLogin no/PermitRootLogin yes/' /etc/ssh/sshd_config
    systemctl restart ssh

  SHELL

  # =====================================================
  # K3s SERVER (Controller)
  # =====================================================
  config.vm.define "ialves-S" do |node|
    node.vm.hostname = "ialves-S"
    node.vm.network "private_network",
      ip: "192.168.56.110",
      netmask: "255.255.255.0",
      virtualbox__intnet: false

    node.vm.provider :virtualbox do |vb|
      vb.memory = 1024
      vb.cpus = 1
      vb.name = "ialves-S"
    end

    node.vm.provision "shell", inline: <<-SHELL
      echo "=== Installing K3s Server (Controller) ==="
      curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="\
            --write-kubeconfig-mode 644 \
            --disable traefik \
            --bind-address=192.168.56.110 \
            --advertise-address=192.168.56.110 \
            --node-ip=192.168.56.110 \
            --node-external-ip=192.168.56.110" \
          sh -

      echo "=== Waiting for K3s server to become ready ==="
      until systemctl is-active --quiet k3s; do
        echo "Waiting for k3s service..."
        sleep 5
      done

      echo "=== Saving node token for later access ==="
      cat /var/lib/rancher/k3s/server/node-token > /root/node-token

      echo "=== Server setup complete ==="

      echo "=== Waiting for K3s to be ready ==="
      sleep 10
      until kubectl get nodes &>/dev/null; do
        echo "Waiting for K3s..."
        sleep 5
      done

      echo "=== Setting up kubectl access for vagrant user ==="
      mkdir -p /home/vagrant/.kube
      cp /etc/rancher/k3s/k3s.yaml /home/vagrant/.kube/config
      chown -R vagrant:vagrant /home/vagrant/.kube
      chmod 600 /home/vagrant/.kube/config

      echo "=== Applying Kubernetes manifests ==="
      if [ -f /home/vagrant/k8s/app1.yaml ]; then
        kubectl apply -f /home/vagrant/k8s/app1.yaml
      fi
      if [ -f /home/vagrant/k8s/app2.yaml ]; then
        kubectl apply -f /home/vagrant/k8s/app2.yaml
      fi
      if [ -f /home/vagrant/k8s/app3.yaml ]; then
        kubectl apply -f /home/vagrant/k8s/app3.yaml
      fi4

      echo "=== K3s installation and app deployment complete ==="
      kubectl get pods --all-namespaces

    SHELL
  end
end
