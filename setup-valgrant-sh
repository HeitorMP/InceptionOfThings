#!/bin/bash
set -e

export PATH=$PATH:/usr/sbin:/sbin

# =========================
# CONFIGURATION
# =========================
USER_NAME="iot"

# =========================
# USER SETUP
# =========================
echo "=== Ensuring user '$USER_NAME' exists ==="
if ! id "$USER_NAME" &>/dev/null; then
    adduser --disabled-password --gecos "" "$USER_NAME"
    echo "$USER_NAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
    echo "User '$USER_NAME' created and added to sudoers."
else
    echo "User '$USER_NAME' already exists."
    if ! grep -q "^$USER_NAME" /etc/sudoers; then
        echo "$USER_NAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
        echo "Added $USER_NAME to /etc/sudoers."
    fi
fi

# =========================
# SYSTEM PREPARATION
# =========================
echo "=== Updating system packages ==="
apt update && apt upgrade -y

echo "=== Installing build essentials and dependencies ==="
apt install -y \
    build-essential \
    dkms \
    libffi-dev \
    ruby-dev \
    rsync \
    gcc \
    make \
    wget \
    sudo \
    ca-certificates \
    gnupg \
    lsb-release \
    curl \
    cpu-checker

echo "=== Removing any existing KVM/Libvirt installation ==="
apt remove -y qemu-kvm libvirt-daemon-system libvirt-clients libvirt-dev virtinst bridge-utils nfs-kernel-server 2>/dev/null || true
systemctl stop libvirtd 2>/dev/null || true
apt autoremove -y 2>/dev/null || true

echo "=== Disabling KVM kernel modules ==="
modprobe -r kvm_intel kvm 2>/dev/null || true
modprobe -r kvm_amd kvm 2>/dev/null || true

# Blacklist KVM modules to prevent auto-load
cat > /etc/modprobe.d/blacklist-kvm.conf << 'EOF'
blacklist kvm_intel
blacklist kvm_amd
blacklist kvm
EOF

echo "=== Checking VT-x support (required for VirtualBox) ==="
if grep -q vmx /proc/cpuinfo; then
    echo "‚úÖ VT-x (VMX) is available in CPU"
else
    echo "‚ö†Ô∏è  WARNING: VT-x not detected in /proc/cpuinfo"
    echo "   - This might mean it's disabled in BIOS"
    echo "   - Please restart and enable VT-x/AMD-V in BIOS settings"
fi

echo "=== Adding VirtualBox repository for Debian ==="
# Get Debian codename
DEBIAN_CODENAME=$(lsb_release -cs)

# Add Oracle VirtualBox public key using modern method
echo "Adding VirtualBox GPG keys..."
wget -qO- https://www.virtualbox.org/download/oracle_vbox_2016.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/oracle-virtualbox-2016.gpg > /dev/null
wget -qO- https://www.virtualbox.org/download/oracle_vbox.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/oracle-virtualbox.gpg > /dev/null

# Add VirtualBox repository
echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/oracle-virtualbox-2016.gpg] http://download.virtualbox.org/virtualbox/debian $DEBIAN_CODENAME contrib" | tee /etc/apt/sources.list.d/virtualbox.list

apt update

echo "=== Installing VirtualBox ==="
# Install latest VirtualBox available for this Debian version
apt install -y virtualbox-7.2 || apt install -y virtualbox-7.1 || apt install -y virtualbox

echo "=== Installing VirtualBox Extension Pack ==="
VBOX_VERSION=$(vboxmanage --version | cut -d 'r' -f 1)
EXTPACK_URL="https://download.virtualbox.org/virtualbox/${VBOX_VERSION}/Oracle_VM_VirtualBox_Extension_Pack-${VBOX_VERSION}.vbox-extpack"
EXTPACK_FILE="/tmp/Oracle_VM_VirtualBox_Extension_Pack.vbox-extpack"

if wget -q -O "$EXTPACK_FILE" "$EXTPACK_URL"; then
    VBoxManage extpack install --replace "$EXTPACK_FILE" || true
    rm -f "$EXTPACK_FILE"
else
    echo "‚ö†Ô∏è  Warning: Could not download Extension Pack. Continuing without it."
fi

echo "=== Adding user '$USER_NAME' to vboxusers group ==="
/usr/sbin/usermod -aG vboxusers "$USER_NAME"
/usr/sbin/usermod -aG sudo "$USER_NAME"

# =========================
# VAGRANT INSTALLATION
# =========================
echo "=== Installing Vagrant (version 2.4.9) ==="
VAGRANT_DEB="/tmp/vagrant_2.4.9-1_amd64.deb"
wget -q -O "$VAGRANT_DEB" https://releases.hashicorp.com/vagrant/2.4.9/vagrant_2.4.9-1_amd64.deb
dpkg -i "$VAGRANT_DEB" || apt install -f -y
rm "$VAGRANT_DEB"

echo "=== Installing vagrant plugins ==="
sudo -u "$USER_NAME" vagrant plugin install vagrant-vbguest || true
sudo -u "$USER_NAME" vagrant plugin install vagrant-disksize || true


# =========================
# CLEANUP
# =========================
echo "=== Cleaning up temporary files ==="
apt autoremove -y

# =========================
# COMPLETION
# =========================
echo ""
echo "‚úÖ INSTALLATION COMPLETE!"
echo ""
echo "‚ö†Ô∏è  IMPORTANT - BEFORE REBOOTING:"
echo "   On the HOST machine (where this VM runs), execute ONCE:"
echo ""
echo "   VBoxManage modifyvm 'iot' --nested-hw-virt on"
echo ""
echo "   Or enable it in VirtualBox GUI:"
echo "   - Right-click VM 'iot' ‚Üí Settings"
echo "   - System ‚Üí Processor"
echo "   - Check: ‚òë Enable Nested VT-x/AMD-V"
echo ""
echo "üîÅ After that, REBOOT this VM:"
echo "   reboot"
echo ""
echo "After reboot, you can create the exercise VMs:"
echo ""
echo "   su - $USER_NAME"
echo "   cd p1"
echo "   vagrant up --provider=virtualbox"
echo ""
echo "Or for single-node K3s cluster:"
echo "   cd p2"
echo "   vagrant up --provider=virtualbox"
echo ""
echo "Check VirtualBox status:"
echo "   VBoxManage list vms"

