Vagrant.configure("2") do |config|
  config.vm.box = "generic/debian12"

  # =====================================================
  # COMMON BASE SETUP (applies to all VMs)
  # =====================================================
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update -y
    apt-get install -y curl rsync openssh-client openssh-server sshpass
    systemctl enable ssh
    systemctl start ssh

    # Set root password for all VMs (rootpass)
    echo "root:rootpass" | chpasswd

    # Allow root login with password via SSH
    sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
    sed -i 's/^PermitRootLogin no/PermitRootLogin yes/' /etc/ssh/sshd_config
    systemctl restart ssh

    # Configure DNS for Ubuntu Server
    cat > /etc/netplan/99-custom-dns.yaml << 'EOF'
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: true
      dhcp4-overrides:
        use-dns: false
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
EOF
    netplan apply
  SHELL

  # =====================================================
  # K3s SERVER (Controller)
  # =====================================================
  config.vm.define "hmaciel-S" do |node|
    node.vm.hostname = "hmaciel-S"
    
    # Bridge network for easy access
    node.vm.network "public_network", bridge: "en0"

    node.vm.provider :virtualbox do |vb|
      vb.memory = 1024
      vb.cpus = 2
      vb.name = "hmaciel-S"
    end

    node.vm.provision "shell", inline: <<-SHELL
      echo "=== Installing K3s Server (Controller) ==="
      curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode 644 --disable traefik" sh -

      echo "=== Waiting for K3s server to become ready ==="
      until systemctl is-active --quiet k3s; do
        echo "Waiting for k3s service..."
        sleep 5
      done

      echo "=== Saving node token for later access ==="
      cat /var/lib/rancher/k3s/server/node-token > /root/node-token

      echo "=== Server setup complete ==="
    SHELL
  end

  # =====================================================
  # K3s WORKER (Agent)
  # =====================================================
  config.vm.define "joaoalme-SW" do |node|
    node.vm.hostname = "joaoalme-SW"
    
    # Bridge network for easy access
    node.vm.network "public_network", bridge: "en0"

    node.vm.provider :virtualbox do |vb|
      vb.memory = 1024
      vb.cpus = 2
      vb.name = "joaoalme-SW"
    end

    node.vm.provision "shell", inline: <<-SHELL
      # Get server IP from environment or use default
      SERVER_IP="${SERVER_IP:-hmaciel-S}"
      PASSWORD="rootpass"

      echo "=== Waiting to fetch K3s token from server ==="
      for i in $(seq 1 10); do
        echo "Attempt $i to fetch token from server..."
        sshpass -p $PASSWORD scp -o StrictHostKeyChecking=no root@${SERVER_IP}:/root/node-token /tmp/node-token && break
        echo "Token not found yet, retrying in 10s..."
        sleep 10
      done

      if [ ! -f /tmp/node-token ]; then
        echo "❌ Could not retrieve node-token from server. Aborting."
        exit 1
      fi

      TOKEN=$(cat /tmp/node-token)
      echo "✅ Node token retrieved successfully."

      echo "=== Installing K3s Agent (Worker) ==="
      # Try to resolve server hostname first, fall back to IP
      if ping -c 1 $SERVER_IP &> /dev/null; then
        SERVER_IP=$(ping -c 1 $SERVER_IP | grep -oP '(?<=\()\d+\.\d+\.\d+\.\d+(?=\))' | head -1)
      fi
      
      curl -sfL https://get.k3s.io | K3S_URL="https://${SERVER_IP}:6443" K3S_TOKEN="${TOKEN}" sh -

      echo "=== Worker node joined the cluster ==="
    SHELL
  end
end
